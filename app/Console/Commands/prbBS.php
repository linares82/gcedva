<?php

namespace App\Console\Commands;

use App\Param;
use Exception;
use App\Adeudo;
use App\BsBaja;
use App\Cliente;
use Carbon\Carbon;
use App\Seguimiento;
use GuzzleHttp\Psr7;
use GuzzleHttp\Client;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use GuzzleHttp\Exception\GuzzleException;
use App\valenceSdk\samples\BasicSample\UsoApi;

class prbBS extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'ian:bs';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Command description';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        /*
        $url=Param::where('llave','url_bSpace')->first();
        $client = new Client(['base_uri' => $url->valor]);
        $version=Param::where('llave','apiVersion_bSpace')->first();
        $result = $client->request('GET', "/d2l/api/lp/".$version->valor."/users/whoami");
        $request = $result->getBody()->getContents();
        dd($request);
        return response()->Json($request);
        */
        $clientes=array(54,
        70/*,
        179,
        199,
        357,
        383,
        491,
        598,
        705,
        723,
        1026,
        1171,
        1303,
        1998,
        2036,
        2095,
        2097,
        2112,
        2499,
        2651,
        2939,
        2963,
        3211,
        3407,
        3424,
        3425,
        3448,
        3520,
        3705,
        3852,
        3856,
        3857,
        3878,
        3886,
        3945,
        3981,
        4001,
        4043,
        4095,
        4101,
        4110,
        4160,
        4173,
        4187,
        4193,
        4234,
        4264,
        4268,
        4273,
        4280,
        4286,
        4303,
        4306,
        4311,
        4312,
        4314,
        4315,
        4316,
        4321,
        4344,
        4350,
        4357,
        4370,
        4380,
        4389,
        4404,
        4412,
        4424,
        4430,
        4436,
        4445,
        4460,
        4462,
        4470,
        4472,
        4475,
        4485,
        4488,
        4508,
        4544,
        4557,
        4572,
        4573,
        4652,
        4680,
        4712,
        4714,
        4717,
        4739,
        4741,
        4773,
        4774,
        4775,
        4790,
        4806,
        4838,
        4840,
        4846,
        4872,
        4895,
        4919,
        4921,
        4922,
        4924,
        5009,
        5020,
        5021,
        5098,
        5099,
        5129,
        5130,
        5139,
        5142,
        5145,
        5166,
        5171,
        5239,
        5267,
        5324,
        5329,
        5343,
        5402,
        5407,
        5412,
        5421,
        5468,
        5472,
        5585,
        5665,
        5708,
        5736,
        5769,
        5771,
        5774,
        5856,
        5902,
        6023,
        6028,
        6064,
        6161,
        6169,
        6171,
        6192,
        6209,
        6232,
        6245,
        6356,
        6362,
        6427,
        6439,
        6463,
        6501,
        6561,
        6607,
        6707,
        6714,
        6953,
        6977,
        6993,
        7020,
        7058,
        7073,
        7174,
        7302,
        7471,
        7497,
        7529,
        7576,
        7590,
        7653,
        7657,
        7668,
        7712,
        7744,
        7764,
        7828,
        7854,
        7857,
        7903,
        7961,
        7997,
        8106,
        8181,
        8182,
        8220,
        8231,
        8283,
        8298,
        8311,
        8316,
        8318,
        8344,
        8353,
        8418,
        8519,
        8530,
        8536,
        8549,
        8569,
        8629,
        8659,
        8673,
        8675,
        8685,
        8756,
        8796,
        8825,
        8852,
        8866,
        8901,
        8927,
        8987,
        8992,
        8998,
        9028,
        9338,
        9345,
        9355,
        9368,
        9373,
        9377,
        9576,
        9587,
        9625,
        9637,
        9727,
        9832,
        9866,
        9869,
        9964,
        10004,
        10061,
        10079,
        10080,
        10081,
        10126,
        10177,
        10246,
        10266,
        10269,
        10281,
        10294,
        10296,
        10310,
        10359,
        10368,
        10370,
        10392,
        10393,
        10402,
        10406,
        10407,
        10410,
        10424,
        10447,
        10530,
        10548,
        10570,
        10588,
        10603,
        10641,
        10723,
        10724,
        10736,
        10739,
        10749,
        10753,
        10780,
        10788,
        10789,
        10795,
        10797,
        10804,
        10839,
        10877,
        10893,
        10899,
        10901,
        10955,
        10956,
        10958,
        10959,
        10960,
        10968,
        10971,
        11015,
        11071,
        11111,
        11116,
        11118,
        11163,
        11187,
        11191,
        11338,
        11346,
        11352,
        11378,
        11427,
        11428,
        11430,
        11432,
        11433,
        11435,
        11456,
        11460,
        11463,
        11466,
        11467,
        11472,
        11474,
        11476,
        11478,
        11479,
        11481,
        11522,
        11538,
        11554,
        11575,
        11584,
        11585,
        11587,
        11592,
        11601,
        11614,
        11632,
        11635,
        11647,
        11668,
        11669,
        11674,
        11714,
        11719,
        11747,
        11768,
        11769,
        11776,
        11780,
        11783,
        11793,
        11799,
        11809,
        11812,
        11815,
        11818,
        11847,
        11852,
        11869,
        11884,
        11890,
        11895,
        12013,
        12015,
        12016,
        12018,
        12022,
        12026,
        12033,
        12081,
        12091,
        12093,
        12099,
        12112,
        12121,
        12129,
        12169,
        12214,
        12317,
        12432,
        12441,
        12459,
        12478,
        12490,
        12532,
        12575,
        12577,
        12579,
        12616,
        12647,
        12725,
        12732,
        12753,
        12758,
        12768,
        12836,
        12849,
        12854,
        12855,
        12861,
        12862,
        12911,
        12922,
        12924,
        12933,
        12937,
        12959,
        12960,
        12976,
        12980,
        12992,
        13007,
        13028,
        13106,
        13154,
        13185,
        13216,
        13226,
        13229,
        13238,
        13245,
        13247,
        13250,
        13251,
        13269,
        13355,
        13475,
        13610,
        13622,
        13651,
        13661,
        13692,
        13782,
        13810,
        13869,
        13874,
        13880,
        13941,
        13944,
        13946,
        13973,
        14011,
        14020,
        14021,
        14023,
        14103,
        14236,
        14264,
        14268,
        14271,
        14281,
        14286,
        14303,
        14395,
        14396,
        14403,
        14405,
        14414,
        14416,
        14425,
        14485,
        14489,
        14539,
        14572,
        14576,
        14581,
        14587,
        14592,
        14608,
        14751,
        14752,
        14759,
        14846,
        14875,
        14950,
        14958,
        14962,
        14973,
        14980,
        14984,
        15022,
        15040,
        15075,
        15076,
        15206,
        15279,
        15395,
        15396,
        15419,
        15421,
        15459,
        15486,
        15577,
        15579,
        15671,
        15935,
        16048,
        16064,
        16093,
        16165,
        16171,
        16211,
        16215,
        16218,
        16226,
        16275,
        16276,
        16277,
        16294,
        16404,
        16441,
        16595,
        16634,
        16705,
        16755,
        16891,
        16896,
        16943,
        16977,
        17004,
        17014,
        17026,
        17115,
        17117,
        17154,
        17162,
        17164,
        17170,
        17181,
        17204,
        17215,
        17228,
        17396,
        17468,
        17482,
        17485,
        17543,
        17569,
        17648,
        17650,
        17651,
        17672,
        17694,
        17696,
        17734,
        17737,
        17743,
        17754,
        17761,
        17763,
        17783,
        17810,
        17823,
        17830,
        17832,
        17839,
        17845,
        17847,
        17853,
        17864,
        17873,
        17900,
        17917,
        17919,
        17931,
        17978,
        17984,
        18007,
        18034,
        18071,
        18073,
        18224,
        18273,
        18302,
        18422,
        18430,
        18434,
        18459,
        18478,
        18542,
        18572,
        18614,
        18615,
        18616,
        18626,
        18668,
        18709,
        18737,
        18766,
        18792,
        18861,
        18871,
        18968,
        18969,
        19046,
        19224,
        19250,
        19251,
        19372,
        19386,
        19439,
        19443,
        19551,
        19648,
        19655,
        19658,
        19686,
        19730,
        19744,
        19796,
        19805,
        19827,
        19866,
        19892,
        19918,
        19936,
        19963,
        20003,
        20035,
        20050,
        20077,
        20104,
        20157,
        20158,
        20174,
        20195,
        20201,
        20231,
        20262,
        20273,
        20274,
        20362,
        20411,
        20463,
        20469,
        20489,
        20526,
        20534,
        20567,
        20574,
        20576,
        20589,
        20613,
        20659,
        20667,
        20709,
        20712,
        20724,
        20725,
        20734,
        20743,
        20745,
        20749,
        20755,
        20779,
        20864,
        20880,
        20896,
        20917,
        20926,
        20934,
        20947,
        20951,
        20962,
        20983,
        20990,
        21008,
        21156,
        21204,
        21228,
        21233,
        21259,
        21281,
        21290,
        21320,
        21358,
        21380,
        21470,
        21512,
        21518,
        21758,
        21949,
        21950,
        22041,
        22075,
        22082,
        22109,
        22174,
        22192,
        22194,
        22256,
        22291,
        22334,
        22344,
        22362,
        22408,
        22411,
        22509,
        22516,
        22523,
        22531,
        22540,
        22557,
        22562,
        22565,
        22566,
        22571,
        22573,
        22588,
        22593,
        22616,
        22650,
        22674,
        22707,
        22724,
        22750,
        22753,
        22756,
        22767,
        22770,
        22796,
        22800,
        22885,
        22895,
        22923,
        22950,
        22962,
        22967,
        22968,
        22999,
        23000,
        23005,
        23008,
        23047,
        23049,
        23050,
        23053,
        23057,
        23065,
        23069,
        23071,
        23077,
        23104,
        23116,
        23121,
        23132,
        23135,
        23138,
        23144,
        23147,
        23151,
        23166,
        23170,
        23173,
        23175,
        23176,
        23177,
        23192,
        23193,
        23219,
        23220,
        23221,
        23222,
        23226,
        23230,
        23234,
        23235,
        23301,
        23363,
        23376,
        23394,
        23397,
        23408,
        23431,
        23434,
        23436,
        23437,
        23447,
        23451,
        23453,
        23456,
        23458,
        23460,
        23461,
        23462,
        23463,
        23465,
        23469,
        23470,
        23471,
        23476,
        23479,
        23483,
        23485,
        23486,
        23500,
        23520,
        23535,
        23536,
        23539,
        23556,
        23570,
        23578,
        23610,
        23618,
        23622,
        23646,
        23667,
        23669,
        23677,
        23679,
        23686,
        23694,
        23704,
        23710,
        23733,
        23738,
        23739,
        23751,
        23753,
        23758,
        23759,
        23776,
        23790,
        23794,
        23827,
        23850,
        23863,
        23871,
        23873,
        23914,
        23932,
        23937,
        23938,
        23940,
        23942,
        23943,
        23945,
        23952,
        23969,
        23973,
        23994,
        24000,
        24002,
        24013,
        24033,
        24036,
        24037,
        24040,
        24066,
        24069,
        24100,
        24112,
        24215,
        24248,
        24267,
        24269,
        24276,
        24293,
        24304,
        24315,
        24334,
        24342,
        24380,
        24406,
        24428,
        24441,
        24443,
        24447,
        24463,
        24465,
        24466,
        24473,
        24476,
        24550,
        24553,
        24554,
        24563,
        24589,
        24594,
        24614,
        24615,
        24635,
        24665,
        24687,
        24690,
        24691,
        24728,
        24787,
        24792,
        24873,
        24878,
        24897,
        24914,
        24915,
        24926,
        25025,
        25044,
        25441,
        25442,
        25443,
        25721,
        26384,
    26848*/);
        $bs_activo=$param=Param::where('llave','api_brightSpace_activa')->first();
        if($bs_activo->valor==1){
			$apiBs=new UsoApi();
			
			//Se busca la version de uso de la API
			$param=Param::where('llave','apiVersion_bSpace')->first();
			
			//Lineas comentadas para ejecutar la url de Whoami
			//$resultado=$apiBs->doValence2('GET','/d2l/api/lp/' . $param->valor . '/users/whoami');
			//dd($resultado);
			
			//Se recorren los clientes para obtener datos de brigthspace
			foreach($clientes as $c){
				try {
					$alumno=Cliente::find($c);
				$fechaActual = Carbon::createFromFormat('Y-m-d', Date('Y-m-d'));
				$adeudos = Adeudo::select(DB::raw('adeudos.cliente_id, count(adeudos.cliente_id) as adeudos_cantidad'))
					->join('clientes as c', 'c.id', '=', 'adeudos.cliente_id')
					->join('combinacion_clientes as cc', 'cc.cliente_id', '=', 'c.id')
					->where('cc.plantel_id', '>', 0)
					->where('cc.especialidad_id', '>', 0)
					->where('cc.nivel_id', '>', 0)
					->where('cc.grado_id', '>', 0)
					->where('cc.turno_id', '>', 0)
					->whereColumn('adeudos.combinacion_cliente_id', 'cc.id')
					->join('caja_conceptos as caj_con', 'caj_con.id', '=', 'adeudos.caja_concepto_id')
					->where('caj_con.bnd_mensualidad', 1)
					->where('fecha_pago', '<', $fechaActual)
					->where('pagado_bnd', 0)
					->whereNotIn('c.plantel_id',array(54))
					->whereNull('cc.deleted_at')
					->whereNull('c.deleted_at')
					->where('c.id', $alumno->id)
					->where('c.st_cliente_id', '<>', 3)
					->groupBy('adeudos.cliente_id')
					->having('adeudos_cantidad', '>=', 2)
					->first();
				//dd($registros)	
				//dd($alumno->matricula);
			
				if($alumno->matricula<>"" and !is_null($alumno->matricula)){
					//Se invoca el metodo doValence con los parametros del verbo y la url igual que en el ejemplo del SDK
					//$resultado=$apiBs->doValence('GET','/d2l/api/lp/' . $param->valor . '/users/?orgDefinedId='.$alumno->matricula);
					$resultado=$apiBs->doValence2('GET','/d2l/api/lp/' . $param->valor . '/users/?orgDefinedId='.$alumno->matricula);
		
					//Muestra resultado
					$r=$resultado[0];
					//dd($r['UserId']);

					$datos=['isActive'=>False];
					//dd($datos);
					if(isset($r['UserId'])){
						$resultado2=$apiBs->doValence2('PUT','/d2l/api/lp/' . $param->valor . '/users/'.$r['UserId'].'/activation',$datos);
						//dd($resultado2);
						if(isset($resultado2['IsActive']) and !$resultado2['IsActive']){
							$input['cliente_id']=$alumno->id;
							$input['fecha_baja']=Date('Y-m-d');
							$input['bnd_baja']=1;
							$input['usu_alta_id']=Auth::user()->id;
							$input['usu_mod_id']=Auth::user()->id;
							BsBaja::create($input);
							if ($adeudos->adeudos_cantidad == 2) {
								//echo $registro->cliente_id . '-';
								//$cliente = Cliente::find($registro->cliente_id);
								//Log::info("cliente-" . $cliente->id . "-st" . $cliente->st_cliente_id);
								$alumno->st_cliente_id = 25;
								$alumno->save();

								$seguimiento = Seguimiento::where('cliente_id', $alumno->id)->first();
								//Log::info("seguimiento-" . $seguimiento->id . "-st" . $seguimiento->st_seguimiento_id);
								$seguimiento->st_seguimiento_id = 2;
								$seguimiento->save();
							} elseif ($alumno->adeudos_cantidad >= 3) {
								//$cliente = Cliente::find($registro->cliente_id);
								$alumno->st_cliente_id = 26;
								$alumno->save();

								$adeudos = Adeudo::where('cliente_id', $alumno->cliente_id)
									->where('caja_id', 0)
									->where('pagado_bnd', 0)
									->whereDate('adeudos.fecha_pago','>',Date('Y-m-d'))
									->get();
								//dd($adeudos->toArray());
								foreach ($adeudos as $adeudo) {
									$adeudo->delete();
								}

								$seguimiento = Seguimiento::where('cliente_id', $alumno->id)->first();
								$seguimiento->st_seguimiento_id = 6;
								$seguimiento->save();
							}
							
						}else{
							$input['cliente_id']=$alumno->id;
							$input['fecha_baja']=Date('Y-m-d');
							$input['bnd_baja']=0;
							$input['usu_alta_id']=Auth::user()->id;
							$input['usu_mod_id']=Auth::user()->id;
							BsBaja::create($input);
						}
					}
					//dd($resultado2['IsActive']);
				}
				} catch (Exception $e) {
					Log::info("cliente no encontrado en Brigth Space u otro error: ".$alumno->matricula." - ".$e->getMessage());
					//return false;
				}
			}
		}
    }
}
